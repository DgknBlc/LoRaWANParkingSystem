<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LoRaWAN Akıllı Park Sistemi</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
      type="text/css"
    />
    <div id="map"></div>
    <script src="https://unpkg.com/es6-promise@4.2.4/dist/es6-promise.auto.min.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
    <script>
      var parkNoktalari = {
        "251": [36.26267693406108, 41.341548855114],
        "272": [36.260460555302664, 41.342952802563374],
        "568": [36.26143543050793, 41.342191291344776],
      };
      var konum1Renk;
      var konum2Renk;
      var konum3renk;
      const yesilRenk = '#34c754';
      const kirmiziRenk = '#f01818';
      let url2 =
        'https://api.thingspeak.com/channels/1380146/feeds/last.json?api_key=U09E9TP3T8NQSGHN';

      var map;
      function fetchData() {
        fetch(url2)
          .then((res) => res.json())
          .then((out) => {
            setMarkers(out);
          });
      }
      window.addEventListener('load', function () {
        fetch(url2)
          .then((res) => res.json())
          .then((out) => {
            mapboxgl.accessToken =
              'pk.eyJ1IjoiZGF2b3QxMzY5NSIsImEiOiJja3BiYmR4YzQxMTVvMm9tcHBiNW80cm1yIn0.4AoItntaVis_s_-MJzUfOw';
            var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });
            mapboxClient.geocoding
              .forwardGeocode({
                query: 'Atakum,Samsun',
                autocomplete: false,
                limit: 1,
              })
              .send()
              .then(function (response) {
                if (
                  response &&
                  response.body &&
                  response.body.features &&
                  response.body.features.length
                ) {
                  var feature = response.body.features[0];

                  map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: [36.260682, 41.342564],
                    zoom: 15,
                  });
                  map.addControl(
                    new MapboxDirections({
                      accessToken: mapboxgl.accessToken,
                    }),
                    'top-right'
                  );

                  Object.keys(parkNoktalari).forEach((key) => {
                    new mapboxgl.Marker({
                      draggable: false,
                    })
                    .setLngLat(parkNoktalari[key])
                    .addTo(map);
                  });
                }
              });
          });
        var fetchInterval = 5000;

        setInterval(fetchData, fetchInterval);
      });

        function setMarkers(data) {
            Object.keys(data).forEach((key) => {
              if(key.includes('field') && data[key] !== '0') {
                  const available = data[key].substring(0, 1);
                  const parkNoktasi = data[key].substring(1, data[key].length);
                  new mapboxgl.Marker({
                      color: available === "1" ? yesilRenk : kirmiziRenk ,
                      draggable: false,
                    })
                      .setLngLat(parkNoktalari[parkNoktasi])
                      .addTo(map);
              }
            });
        }
    </script>
  </body>
</html>
